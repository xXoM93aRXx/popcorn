<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Create a custom registration template that we can call instead of the default one -->
        <template id="popcorn_custom_registration_button" name="Popcorn Custom Registration Button">
            <!-- Check if event is in freeze period for current user -->
            <t t-set="is_frozen" t-value="False"/>
            <t t-set="frozen_membership" t-value="None"/>
            <t t-if="request.env.user.id != request.env.ref('base.public_user').id">
                <t t-set="is_frozen" t-value="event.is_in_freeze_period(request.env.user.partner_id)[0]"/>
                <t t-if="is_frozen" t-set="frozen_membership" t-value="event.is_in_freeze_period(request.env.user.partner_id)[1]"/>
            </t>
            
            <!-- Fixed registration button container -->
            <div class="popcorn-fixed-registration-container">
                <t t-if="event.is_participating">
                    <button type="button" 
                            t-att-class="'btn btn-secondary popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                            disabled="disabled"
                            t-att-title="'Already registered for this event'">
                        <i class="fa fa-check me-2"/> <span t-translation="on">Already Registered</span>
                    </button>
                </t>
                <t t-elif="event.user_waitlist_position and event.user_waitlist_position > 0">
                    <button type="button" 
                            t-att-class="'btn btn-info popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                            disabled="disabled"
                            t-att-title="'You are on the waitlist for this event'">
                        <i class="fa fa-clock-o me-2"/> <span t-translation="on">You are #<t t-esc="event.user_waitlist_position"/> on the waitlist</span>
                    </button>
                </t>
                <t t-elif="is_frozen">
                    <button type="button" 
                            t-att-class="'btn btn-warning popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                            disabled="disabled"
                            t-att-title="'Membership is frozen during this event period'">
                        <i class="fa fa-pause me-2"/> <span t-translation="on">Membership Frozen</span>
                        <t t-if="frozen_membership">
                            <br/><small><span t-translation="on">Until</span> <t t-esc="frozen_membership.freeze_end"/></small>
                        </t>
                    </button>
                </t>
                <t t-elif="event.has_conflicting_registration">
                    <div class="popcorn-conflict-buttons">
                        <button type="button" 
                                t-att-class="'btn btn-warning popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                                disabled="disabled"
                                t-att-title="'You have a conflicting registration for another event at the same time'">
                            <i class="fa fa-calendar-times-o me-2"/> 
                            <span t-translation="on">Oops! It looks like you already booked</span>
                            <t t-if="event.conflicting_event">
                                <span t-translation="on"> (<t t-esc="event.conflicting_event.name"/>)</span>
                            </t>
                        </button>
                        <t t-if="event.conflicting_event">
                            <button type="button" 
                                    t-att-class="'btn btn-outline-danger btn-sm ' + (cta_additional_classes or '')"
                                    style="width: 100%; margin-top: 8px;"
                                    t-att-data-conflicting-event-id="event.conflicting_event.id"
                                    onclick="confirmCancelConflictingRegistration(this)">
                                <i class="fa fa-times me-1"/> <span t-translation="on">Cancel Registration:</span> <t t-esc="event.conflicting_event.name"/>
                            </button>
                        </t>
                    </div>
                </t>
                <t t-elif="event.event_registrations_open or (event.seats_limited and event.seats_available == 0)">
                    <!-- Check if event is full and has waitlist capability -->
                    <t t-if="event.seats_limited and event.seats_available == 0">
                        <a t-att-href="'/popcorn/event/' + slug(event) + '/register'" 
                           t-att-class="'btn btn-warning popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                           t-att-title="'Join the waitlist for this event'">
                            <i class="fa fa-clock-o me-2"/> <span t-translation="on">Join the Waitlist</span>
                        </a>
                    </t>
                    <t t-else="">
                        <a t-att-href="'/popcorn/event/' + slug(event) + '/register'" 
                           t-att-class="'btn btn-primary popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                           t-att-title="'Register for this event'">
                            <i class="fa fa-ticket me-2"/> <span t-translation="on">Register Now</span>
                        </a>
                    </t>
                </t>
                <t t-else="">
                    <button type="button" 
                            t-att-class="'btn btn-secondary popcorn-fixed-registration-button ' + (cta_additional_classes or '')"
                            disabled="disabled"
                            t-att-title="'Registrations are closed'">
                        <i class="fa fa-ban me-2"/> <span t-translation="on">Registrations Closed</span>
                    </button>
                </t>
            </div>
        </template>

        <!-- Override the default registration template to use our custom button -->
        <template id="popcorn_registration_template_override" name="Popcorn Registration Template Override" inherit_id="website_event.registration_template">
            <xpath expr="." position="replace">
                <t t-call="popcorn.popcorn_custom_registration_button"/>
            </xpath>
        </template>
    </data>
</odoo>
