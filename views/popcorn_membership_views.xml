<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        
        <!-- Membership List View -->
        <record id="view_popcorn_membership_list" model="ir.ui.view">
            <field name="name">popcorn.membership.list</field>
            <field name="model">popcorn.membership</field>
            <field name="arch" type="xml">
                <list string="Memberships">
                    <field name="partner_id"/>
                    <field name="partner_phone"/>
                    <field name="membership_plan_id"/>
                    <field name="state" decoration-info="state == 'pending'" decoration-warning="state == 'frozen'" decoration-danger="state == 'expired'"/>
                    <field name="activation_date"/>
                    <field name="effective_end_date"/>
                    <field name="purchase_price_paid"/>
                    <field name="price_tier"/>
                    <field name="purchase_channel"/>
                    <field name="remaining_offline" optional="show"/>
                    <field name="remaining_online" optional="show"/>
                    <field name="remaining_sp" optional="show"/>
                    <field name="points_remaining" optional="show"/>
                </list>
            </field>
        </record>
        
        <!-- Membership Form View -->
        <record id="view_popcorn_membership_form" model="ir.ui.view">
            <field name="name">popcorn.membership.form</field>
            <field name="model">popcorn.membership</field>
            <field name="arch" type="xml">
                <form string="Membership">
                    <header>
                        <button name="action_activate" string="Activate" type="object" 
                                class="oe_highlight" 
                                invisible="state != 'pending'"/>
                        <button name="action_activate_pending_payment" string="Activate" type="object" 
                                class="oe_highlight" 
                                invisible="state != 'pending_payment'"
                                confirm="Are you sure you want to activate this membership? This will mark the payment as completed."/>
                        <button name="action_expire" string="Expire" type="object" 
                                class="btn-danger" 
                                invisible="state not in ['active', 'frozen']"/>
                        <field name="state" widget="statusbar" 
                               statusbar_visible="pending,pending_payment,active,frozen,expired"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <h1>
                                <field name="display_name" readonly="1"/>
                            </h1>
                        </div>
                        <group>
                            <group string="Member Information">
                                <field name="partner_id"/>
                                <field name="partner_phone"/>
                                <field name="membership_plan_id"/>
                                <field name="state"/>
                                <field name="purchase_channel"/>
                                <field name="price_tier"/>
                            </group>
                            <group string="Membership Details">
                                <field name="purchase_price_paid"/>
                                <field name="activation_date"/>
                                <field name="end_date_base"/>
                                <field name="effective_end_date"/>
                                <field name="upgrade_discount_allowed"/>
                                <field name="first_timer_customer"/>
                                <field name="contract_id"/>
                            </group>
                        </group>
                        
                        <!-- Action Buttons in Sheet -->
                        <div class="oe_button_box" name="button_box">
                            <button name="action_activate_pending_payment" string="Activate Payment" type="object" 
                                    class="oe_stat_button" icon="fa-check"
                                    invisible="state != 'pending_payment'"
                                    confirm="Are you sure you want to activate this membership? This will mark the payment as completed.">
                                <field name="state" widget="statinfo" string="Status"/>
                            </button>
                            <button name="action_create_contract" string="Create Contract" type="object" 
                                    class="oe_stat_button" icon="fa-file-text-o"
                                    invisible="contract_id"
                                    confirm="Create a contract for this membership?">
                                <field name="contract_id" widget="statinfo" string="Contract"/>
                            </button>
                            <button name="action_view_contract" string="View Contract" type="object" 
                                    class="oe_stat_button" icon="fa-file-text-o"
                                    invisible="not contract_id">
                                <field name="contract_id" widget="statinfo" string="Contract"/>
                            </button>
                        </div>
                        
                        <!-- Debug: Always visible button for testing -->
                        <div class="alert alert-info" invisible="state != 'pending_payment'">
                            <strong>Pending Payment:</strong> This membership is waiting for payment confirmation.
                            <button name="action_activate_pending_payment" string="Activate Now" type="object" 
                                    class="btn btn-primary btn-sm" style="margin-left: 10px;"
                                    confirm="Are you sure you want to activate this membership? This will mark the payment as completed."/>
                        </div>
                        
                        <notebook>
                            <page string="Usage &amp; Quota" name="usage">
                                <group>
                                    <group string="Remaining Usage">
                                        <field name="remaining_offline" widget="integer"/>
                                        <field name="remaining_online" widget="integer"/>
                                        <field name="remaining_sp" widget="integer"/>
                                        <field name="points_remaining" widget="integer"/>
                                    </group>
                                    <group string="Plan Limits">
                                        <field name="plan_duration_days"/>
                                        <field name="plan_quota_mode"/>
                                        <field name="plan_allowed_regular_offline"/>
                                        <field name="plan_allowed_regular_online"/>
                                        <field name="plan_allowed_spclub"/>
                                    </group>
                                </group>
                            </page>
                            
                            <page string="Freeze &amp; Extensions" name="freeze">
                                <group>
                                    <group string="Freeze Status">
                                        <field name="freeze_active"/>
                                        <field name="freeze_start"/>
                                        <field name="freeze_end"/>
                                        <field name="freeze_total_days_used"/>
                                    </group>
                                    <group string="Extensions">
                                        <field name="extra_days_extension"/>
                                    </group>
                                </group>
                                <group string="Freeze Actions" invisible="not freeze_active">
                                    <button name="action_unfreeze" string="End Freeze" type="object" class="btn-warning"/>
                                </group>
                            </page>
                            
                            <page string="Manual Adjustments" name="adjustments">
                                <group>
                                    <group string="Session Adjustments">
                                        <field name="adj_offline"/>
                                        <field name="adj_online"/>
                                        <field name="adj_sp"/>
                                    </group>
                                    <group string="Points Adjustments">
                                        <field name="adj_points"/>
                                    </group>
                                </group>
                                <p class="text-muted">
                                    <i class="fa fa-info-circle"/> These adjustments are tracked in the chatter for audit purposes.
                                </p>
                            </page>
                        </notebook>
                        
                        <chatter/>
                    </sheet>
                </form>
            </field>
        </record>
        
        <!-- Membership Kanban View -->
        <record id="view_popcorn_membership_kanban" model="ir.ui.view">
            <field name="name">popcorn.membership.kanban</field>
            <field name="model">popcorn.membership</field>
            <field name="arch" type="xml">
                <kanban string="Memberships" class="o_kanban_small_column" default_group_by="state">
                    <field name="id"/>
                    <field name="partner_id"/>
                    <field name="partner_phone"/>
                    <field name="membership_plan_id"/>
                    <field name="state"/>
                    <field name="activation_date"/>
                    <field name="effective_end_date"/>
                    <field name="remaining_offline"/>
                    <field name="remaining_online"/>
                    <field name="remaining_sp"/>
                    <field name="points_remaining"/>
                    <templates>
                        <t t-name="kanban-box">
                            <div class="oe_kanban_card oe_kanban_global_click">
                                <div class="oe_kanban_content">
                                    <div class="o_kanban_record_top">
                                        <div class="o_kanban_record_headings">
                                            <strong class="o_kanban_record_title">
                                                <field name="partner_id"/>
                                            </strong>
                                            <small class="o_kanban_record_subtitle">
                                                <field name="membership_plan_id"/>
                                            </small>
                                            <small class="o_kanban_record_subtitle">
                                                <field name="partner_phone"/>
                                            </small>
                                        </div>
                                        <div class="o_kanban_record_top_right">
                                            <field name="state" widget="label_selection" 
                                                   options="{'classes': {'pending': 'info', 'active': 'success', 'frozen': 'warning', 'expired': 'danger'}}"/>
                                        </div>
                                    </div>
                                    <div class="o_kanban_record_body">
                                        <div class="row">
                                            <div class="col-6">
                                                <small>Activation: <field name="activation_date"/></small>
                                            </div>
                                            <div class="col-6">
                                                <small>Expires: <field name="effective_end_date"/></small>
                                            </div>
                                        </div>
                                        <div class="row mt-2">
                                            <div class="col-12">
                                                <small>
                                                    <span t-if="record.remaining_offline.raw_value != -1">
                                                        Offline: <field name="remaining_offline"/> | 
                                                    </span>
                                                    <span t-if="record.remaining_online.raw_value != -1">
                                                        Online: <field name="remaining_online"/> | 
                                                    </span>
                                                    <span t-if="record.remaining_sp.raw_value != -1">
                                                        SP: <field name="remaining_sp"/> | 
                                                    </span>
                                                    <span t-if="record.points_remaining.raw_value != -1">
                                                        Points: <field name="points_remaining"/>
                                                    </span>
                                                    <span t-if="record.remaining_offline.raw_value == -1">
                                                        Unlimited
                                                    </span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </templates>
                </kanban>
            </field>
        </record>
        
        <!-- Membership Search View -->
        <record id="view_popcorn_membership_search" model="ir.ui.view">
            <field name="name">popcorn.membership.search</field>
            <field name="model">popcorn.membership</field>
            <field name="arch" type="xml">
                <search string="Search Memberships">
                    <field name="partner_id"/>
                    <field name="partner_phone"/>
                    <field name="membership_plan_id"/>
                    <field name="state"/>
                    <field name="purchase_channel"/>
                    <field name="price_tier"/>
                    <filter string="Pending" name="pending" domain="[('state', '=', 'pending')]"/>
                    <filter string="Active" name="active" domain="[('state', '=', 'active')]"/>
                    <filter string="Frozen" name="frozen" domain="[('state', '=', 'frozen')]"/>
                    <filter string="Expired" name="expired" domain="[('state', '=', 'expired')]"/>
                    <filter string="Online Purchases" name="online" domain="[('purchase_channel', '=', 'online')]"/>
                    <filter string="Pitch Day Purchases" name="pitch_day" domain="[('purchase_channel', '=', 'pitch_day')]"/>
                    <filter string="First Timers" name="first_timer" domain="[('price_tier', '=', 'first_timer')]"/>
                    <group expand="0" string="Group By">
                        <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                        <filter string="Plan" name="group_plan" context="{'group_by': 'membership_plan_id'}"/>
                        <filter string="Purchase Channel" name="group_channel" context="{'group_by': 'purchase_channel'}"/>
                        <filter string="Price Tier" name="group_tier" context="{'group_by': 'price_tier'}"/>
                        <filter string="Month" name="group_month" context="{'group_by': 'create_date:month'}"/>
                    </group>
                </search>
            </field>
        </record>
        
        <!-- Membership Action -->
        <record id="action_popcorn_membership" model="ir.actions.act_window">
            <field name="name">Memberships</field>
            <field name="res_model">popcorn.membership</field>
            <field name="view_mode">list,form,kanban</field>
            <field name="context">{'search_default_active': 1}</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create your first membership!
                </p>
                <p>
                    Memberships allow customers to access events based on their plan type and quota.
                </p>
            </field>
        </record>
        
        <!-- Membership Menu Item under Popcorn Root -->
        <menuitem id="menu_popcorn_membership" 
                  name="Memberships" 
                  parent="menu_popcorn_root"
                  action="action_popcorn_membership" 
                  sequence="10"/>
        
        <!-- Server Actions -->
        <record id="action_activate_pending_payment_memberships" model="ir.actions.server">
            <field name="name">Activate Pending Payment Memberships</field>
            <field name="model_id" ref="model_popcorn_membership"/>
            <field name="state">code</field>
            <field name="code">
for membership in records:
    if membership.state == 'pending_payment':
        membership.action_activate_pending_payment()
            </field>
        </record>
        
    </data>
</odoo>

